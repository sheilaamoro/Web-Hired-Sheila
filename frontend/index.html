<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrackIt | Inicio</title>
    <!--Bootstrap CSS-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <!--Favicon de la página web-->
    <link rel="icon" type="image/png" href="./fotos/trackit_verde.png" sizes="16x16 32x32 64x64" />
    <!--Estilos del documento-->
    <link href="estilo_inicio.css" rel="stylesheet">
    <link href="estilos.css" rel="stylesheet">
    <!--Preconexión con Google Fonts-->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!--Fuente del documento-->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&display=swap" rel="stylesheet">
    <!--Iconos de FontAwesome-->
    <script src="https://kit.fontawesome.com/9de74ee228.js" crossorigin="anonymous"></script> 
    <!--Configuracion de la URL-->
    <script src="URL_config.js"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/> 
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script> 

     
</head>

<body>
    
    <!--Navbar-->
    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container">
            <a class="navbar-brand me-auto" href="index.html">TrackIt</a>
            <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasNavbar"
                aria-labelledby="offcanvasNavbarLabel">
                <div class="offcanvas-header">
                    <h5 class="offcanvas-title" id="offcanvasNavbarLabel">TrackIt</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body">
                    <ul class="navbar-nav justify-content-center flex-grow-1 pe-3">
                        <li class="nav-item">
                            <a class="nav-link mx-lg-2 active" aria-current="page" href="index.html">Inicio</a>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link mx-lg-2" href="conocenos.html">Conócenos</a>
                        </li>
                        
                    </ul>
                </div>
            </div>

            <button class="navbar-toggler pe-0" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar" aria-label="Toggle navigation">
                <i class="fa-solid fa-bars" style="color: black;"></i>
            </button>
        </div>
    </nav>
    <!--End Nabvar-->

    <div class="hero text-center">
        <h1 class="hero-title">
            <span class="hero-line">Haz que tu visión sea el doble de inteligente</span>
        </h1>
        <p class="hero-subtitle">Observa y analiza el flujo de personas, coches y bicicletas en tiempo real.</p>
        <a href="#video-container" class="btn hero-cta">Ver en directo <i class="fa-solid fa-chevron-right"></i></a>
        
    </div>


    <div class="container2 nuevo-hero">
        <div class="hero-grid">
            <div class="hero-left video-card" id="video-container">
                <video id="video" data-placeholder-video="./fotos/placeholder-video.mp4" playsinline muted autoplay loop disablepictureinpicture controlslist="nodownload" style="max-width:100%; height:auto; background:#000;" aria-label="Transmisión en directo">
                    <source id="placeholderSource" src="./fotos/placeholder-video.mp4" type="video/mp4">
                    Tu navegador no soporta el elemento <code>video</code>.
                </video>
                <div id="videoOverlay" class="video-overlay" role="status" aria-live="polite">
                   <div class="overlay-inner">
                       <i class="fa-solid fa-satellite-dish fa-2x" aria-hidden="true"></i>
                       <h3>Esperando señal en directo</h3>
                       <p>La cámara está fuera de línea.<br>Vuelve en unos minutos para ver la transmisión.</p>
                       <button class="btn-refresh" onclick="location.reload()">Actualizar</button>
                   </div>
               </div>
            </div>


            <!-- Bloques pequeños de la derecha -->
            <div class="hero-right">
                <div class="hero-top">
                    <h2>Métricas en tiempo real</h2>
                    <p></p>
                    <div class="col-md-12 d-flex justify-content-center gap-3 mb-3 mb-md-0">
                        <div class="card border-success rounded-3 text-center p-1 flex-fill shadow-sm">
                            <i class="fa-solid fa-car fa-lg text-success mb-2" style="padding:4px;"></i>
                            <div id="car-count-value" class="fw-bold fs-6 text-dark">0</div>
                            <div class="text-muted small">Coches</div>
                        </div>

                        <div class="card border-success rounded-3 text-center p-1 flex-fill shadow-sm">
                            <i class="fa-solid fa-person fa-lg text-success mb-2" style="padding:4px;"></i>
                            <div id = "person-count-value" class="fw-bold fs-6 text-dark">0</div>
                            <div class="text-muted small">Personas</div>
                        </div>

                        <div class="card border-success rounded-3 text-center p-1 flex-fill shadow-sm">
                            <i class="fa-solid fa-bicycle fa-lg text-success mb-2" style="padding:4px;"></i>
                            <div id = "bicycle-count-value" class="fw-bold fs-6 text-dark">0</div>
                            <div class="text-muted small">Bicicletas</div>
                        </div>

                    </div>
                </div>

                <!-- <div class="hero-bottom">
                    <div class="chart-container">
                        <canvas id="liveChart" aria-label="Gráfica en directo de métricas" role="img"></canvas>
                    </div>
                </div>

                <div class="hero-bottom">
                    <div class="map-container">
                        
                    </div>
                </div> -->
                
                <div class="hero-carousel-card ">
                    <div id="heroCarousel" class="carousel slide" data-bs-ride="false">
                        <div class="carousel-indicators">
                            <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
                            <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="1" aria-label="Slide 2"></button>
                        </div>
                        <div class="carousel-inner">
                            <!--  CHART -->
                            <div class="carousel-item active">
                                <div class="chart-container">
                                    <canvas id="liveChart"></canvas>
                                </div>
                            </div>
                            <!--  MAPA -->
                            <div class="carousel-item">
                                <div class="map-container" id="map" style="width: 100%; height: 260px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div class="marquee">
        <div class="marquee-wrapper">
            <div class="animate-marquee">
                <div class="logo-item"><img src="fotos/2.png" alt="Logo 1"></div>
                <div class="logo-item"><img src="fotos/epigijon.png" alt="Logo 2"></div>
                <div class="logo-item"><img src="fotos/catedrathin5g.png" alt="Logo 3"></div>
                <div class="logo-item"><img src="fotos/medialab.png" alt="Logo 4"></div>
            </div>
            <!-- segunda tira idéntica para bucle continuo -->
            <div class="animate-marquee" aria-hidden="true">
                <div class="logo-item"><img src="fotos/2.png" alt=""></div>
                <div class="logo-item"><img src="fotos/epigijon.png" alt=""></div>
                <div class="logo-item"><img src="fotos/catedrathin5g.png" alt=""></div>
                <div class="logo-item"><img src="fotos/medialab.png" alt=""></div>
            </div>
            <!-- tercer bloque para bucle perfecto -->
            <div class="animate-marquee" aria-hidden="true">
                <div class="logo-item"><img src="fotos/2.png" alt=""></div>
                <div class="logo-item"><img src="fotos/epigijon.png" alt=""></div>
                <div class="logo-item"><img src="fotos/catedrathin5g.png" alt=""></div>
                <div class="logo-item"><img src="fotos/medialab.png" alt=""></div>
            </div>
            <!-- gradientes de desvanecido en bordes -->
            <div class="marquee-fade marquee-fade-left"></div>
            <div class="marquee-fade marquee-fade-right"></div>
        </div>
    </div>

    <!--- Parte tecnologías usadas-->   
    <div class="container_tecnologias text-center">
        <h3 class="section-subtitle">TECNOLOGÍAS QUE <span class="hero-line-tech">IMPULSAN TRACKIT</span></h3>
        <p>Cada componente de nuestro sistema combina <em>hardware</em> y <em>software</em> de última generación. Desde la detección por <em>IA</em> hasta la transmisión 5G, todo está diseñado para ofrecer un análisis lo más preciso posible y en <b>tiempo real</b> del entorno urbano.</p>
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3">
        <div class="col d-flex">
        <div class="feature-card w-100">
            <i class="fa-brands fa-python tech-icon"></i>
            <h3 class="feature-title"><em>Python</em></h3>
            <p class="feature-subtitle">Lenguaje principal para el desarrollo del <em>backend</em> y procesamiento de vídeo.</p>
        </div>
        </div>

        <div class="col d-flex">
        <div class="feature-card w-100">
            <i class="fa-solid fa-bullseye tech-icon"></i>
            <h3 class="feature-title"><em>Yolo</em></h3>
            <p class="feature-subtitle">Modelo de detección de objetos basado en <em>IA</em> que identifica el tráfico.</p>
        </div>
        </div>

        <div class="col d-flex">
        <div class="feature-card w-100">
            <i class="fa-solid fa-camera tech-icon"></i>
            <h3 class="feature-title"><em>OpenCV</em></h3>
            <p class="feature-subtitle">Biblioteca de visión por computadora para el procesamiento de imágenes y vídeos.</p>
        </div>
        </div>

        <!-- fila 2 -->

        <div class="col d-flex">
        <div class="feature-card w-100">
            <i class="fa-brands fa-raspberry-pi tech-icon"></i>
            <h3 class="feature-title"><em>Raspberry Pi 4</em></h3>
            <p class="feature-subtitle">Unidad de procesamiento local encargada de la captura de vídeo.</p>
        </div>
        </div>   

        <div class="col d-flex">
        <div class="feature-card w-100">
            <i class="fa-solid fa-tower-cell tech-icon"></i>
            <h3 class="feature-title"><em>5G</em></h3>
            <p class="feature-subtitle">Transmisión de datos de alta velocidad mediante el módulo Quectel RM530N en red privada 5G Uniovi.</p>
        </div>
        </div>

        <div class="col d-flex">
        <div class="feature-card w-100">
            <i class="fa-solid fa-database tech-icon"></i>
            <h3 class="feature-title"><em>MySQL</em></h3>
            <p class="feature-subtitle">Base de datos relacional para almacenar métricas, y datos históricos del sistema.</p>
        </div>
        </div>

        <!-- fila 3 -->

        <div class="col-12 col-md-12 d-flex">
        <div class="feature-card w-100">
            <i class="fa-solid fa-drafting-compass tech-icon"></i>
            <h3 class="feature-title"><em>Autodesk Inventor</em></h3>
            <p class="feature-subtitle"><em>Software</em> de diseño CAD 3D empleado para el modelado y prototipado de la carcasa que aloja los componentes del sistema.</p>
        </div>
        </div>   
        </div>
    </div>
    </div>

    <!-- Historial de vídeos grabados junto con sus métricas -->
    <div class="container_videos text-center" id="videos">
    <h3 class="section-subtitle">TODO LO QUE NECESITAS, <span class="hero-line-tech">TODO EN UN SOLO LUGAR</span></h3>
    <p>Revive las emisiones accediendo a <em>todas</em> las grabaciones y explora sus métricas asociadas.</p>
    <div class="table-responsive">
        <table id="fresh-table" class="table">
        <thead>
            <tr>
            <th data-field="fecha" data-sortable="true">Fecha / Hora</th>
            <th data-field="titulo" data-sortable="true">Título</th>
            <th data-field="metrica_coches" data-sortable="true" data-align="center">Coches detectados</th>
            <th data-field="metrica_personas" data-sortable="true" data-align="center">Personas detectadas</th>
            <th data-field="metrica_bici" data-sortable="true" data-align="center">Bicicletas detectadas</th>
            <th data-field="duracion" data-sortable="true" data-align="center">Duración</th>
            </tr>
        </thead>
        <tbody id="videos-table-body">
            <!-- Rellenado dinámico -->
        </tbody>
        </table>
    </div>
    </div>
    

    <!--Footer de la página web-->
    <div class="cuerpo-footer">
        <footer>
            <div class="container-footer">
               <div class="section sobrenosotros">
                    <h2>¿Quiénes somos?</h2>
                    <p>TrackIt te conecta con un universo de historias que suceden en tiempo real. Observa, analiza y descubre cómo se mueven las personas y el tráfico en tu ciudad gracias al potencial del 5G y la inteligencia visual.<br></br>
                    <em>Cada emisión es una ventana viva a la ciudad.</em><br></br>
                    <em>Cada dato, una historia que contar.</em></p>
                <ul class="social">
                    <li><a href="mailto:UO288032@uniovi.es"><i class="fa-regular fa-envelope" aria-hidden="true" style="color: black; font-size: 20px;"></i></a></li>
                    <li><a href="https://www.instagram.com/epigijon/"><i class="fa-brands fa-instagram" aria-hidden="true" style="color: black; font-size: 20px;"></i></a></li>
                    <li><a href="https://twitter.com/epigijon"><i class="fa-brands fa-twitter" aria-hidden="true" style="color: black; font-size: 20px;"></i></a></li>
                    <li><a href="https://www.linkedin.com/school/epigijon/posts/?feedView=all"><i class="fa-brands fa-linkedin" aria-hidden="true" style="color: black; font-size: 20px;"></i></a></li>
                </ul>
                </div>
                <div class="section enlaces">
                    <h2>Nuestras opciones </h2>
                    <ul>
                        <li><a href="index.html">Inicio</a></li>
                        <li><a href="conocenos.html">Conócenos</a></li>
    
                    </ul>
                </div>
                <div class="section contacto">
                    <h2>Contacto</h2>
                    <ul class="info">
                        <li>
                            <span><i class="fa-solid fa-location-dot" aria-hidden="true"></i></span>
                            <span>Campus de Gijón - Universidad de Oviedo<br>Periurbano - Rural, 33203<br> Gijón,
                                Asturias</span>
                        </li>
                        <li>
                            <span><i class="fa-solid fa-phone" aria-hidden="true"></i></span>
                            <p><a href="tel:+34 985 18 22 30">985 18 22 30</a><br>
                                
                            </p>
                        </li>
                        <li>
                            <span><i class="fa-regular fa-envelope" aria-hidden="true"></i></span>
                            <p><a href="mailto:UO288025@uniovi.es">trackit@gmail.com</a></p>
                        </li>
                    </ul>
                </div>
            </div>
        </footer>
        <div class="copyrightText">
            <p> Desarrollado por HIRED 5G — GRUPO 4 &copy; 2025.</p>
        </div>
        </div>
        
        <button id="scroll-up" aria-label="Volver arriba" title="Volver arriba">
            <i class="fa-solid fa-chevron-up" aria-hidden="true"></i>
        </button>



   
    <!--Bootstrap JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous">
    </script>

    <!--Script para cambiar el color de los enlaces del menú OFFCANVAS de la NAVBAR -->
    <script>
        var offcanvas = document.querySelector('.offcanvas');

            offcanvas.addEventListener('show.bs.offcanvas', function () {
                var navLinks = document.querySelectorAll('.offcanvas .nav-link, .offcanvas .nav-link.active');
                navLinks.forEach(function (navLink) {
                    navLink.style.color = 'black';
                });
            });

            offcanvas.addEventListener('hide.bs.offcanvas', function () {
                var navLinks = document.querySelectorAll('.offcanvas .nav-link, .offcanvas .nav-link.active');
                navLinks.forEach(function (navLink) {
                    navLink.style.color = '';
                });
            });
    </script>

    <!--Socket.io JS-->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <script>
    const socket = io();

    // Elementos
    const videoEl = document.getElementById('video');
    if (videoEl) videoEl.tabIndex = -1; 
    const container = document.querySelector('.hero-left.video-card') || (videoEl && videoEl.parentElement) || document.body;

    // Canvas para frames tipo imagen
    let canvas = document.getElementById('videoCanvas');
    if (!canvas) {
        canvas = document.createElement('canvas');
        canvas.id = 'videoCanvas';
        canvas.style.maxWidth = '100%';
        canvas.style.height = 'auto';
        canvas.style.background = '#000';
        canvas.style.display = 'none';
        container.appendChild(canvas);
    }
    const ctx = canvas.getContext('2d');

    // Placeholder
    const placeholderVideo = (videoEl && (videoEl.dataset.placeholderVideo || videoEl.getAttribute('data-placeholder-video'))) || './fotos/placeholder-video.mp4';

    // Funciones
    function resizeCanvas(w, h) {
        canvas.width = w;
        canvas.height = h;
        canvas.style.width = '100%';
        canvas.style.height = '100%';
    }

    function showOverlay() {
        const overlay = document.getElementById('videoOverlay');
        if (!overlay) return;
        overlay.classList.add('active');
    }

    function hideOverlay() {
        const overlay = document.getElementById('videoOverlay');
        if (!overlay) return;
        overlay.classList.remove('active');
    }

    function showPlaceholder() {
        canvas.style.display = 'none';
        if (videoEl) {
            try {
                videoEl.style.display = '';
                videoEl.loop = true;
                if (!videoEl.src || videoEl.src.indexOf(placeholderVideo) === -1) {
                    videoEl.src = placeholderVideo;
                    videoEl.load();
                }
                videoEl.play().catch(()=>{});
            } catch(e){}
        }

        ['car-count-value','person-count-value','bicycle-count-value'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.textContent = '0';
        });
        
        showOverlay();
        if (typeof ConnectionStatus !== 'undefined') ConnectionStatus.setStatus(false);
    }

    // Watchdog solo para frames tipo imagen
    let _imageWatchdog = null;
    const IMAGE_WATCHDOG_TIMEOUT = 6000; // ms

    function resetImageWatchdog() {
        if (_imageWatchdog) clearTimeout(_imageWatchdog);
        _imageWatchdog = setTimeout(() => {
            console.warn('Watchdog: no se han recibido frames de imagen — mostrando placeholder');
            showPlaceholder();
        }, IMAGE_WATCHDOG_TIMEOUT);
    }

    // Socket
    socket.on('frame', data => {
        if (!data || !data.frame) return;

        const frame = data.frame;

        // Frame tipo imagen (data:image o Blob de imagen)
        if ((typeof frame === 'string' && frame.startsWith('data:image')) ||
            (frame instanceof Blob && frame.type.startsWith('image/'))) {

            resetImageWatchdog(); // solo reiniciamos watchdog si es imagen

            hideOverlay();
            canvas.style.display = '';
            if (videoEl) try { videoEl.pause(); videoEl.style.display = 'none'; } catch(e){}

            const img = new Image();
            img.onload = () => {
                resizeCanvas(img.naturalWidth || img.width || 640, img.naturalHeight || img.height || 360);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                URL.revokeObjectURL(frame instanceof Blob ? URL.createObjectURL(frame) : '');
            };
            img.onerror = () => { showPlaceholder(); };

            img.src = frame instanceof Blob ? URL.createObjectURL(frame) : frame;

        } 
        // Vídeo en directo (Blob de vídeo o URL)
        else if ((frame instanceof Blob && frame.type.startsWith('video/')) ||
                (typeof frame === 'string' && (frame.startsWith('data:video') || frame.startsWith('blob:') || frame.startsWith('http') || frame.endsWith('.mp4') || frame.endsWith('.webm')))) {

            // Desactivamos watchdog mientras reproduzca vídeo
            if (_imageWatchdog) { clearTimeout(_imageWatchdog); _imageWatchdog = null; }

            canvas.style.display = 'none';
            if (videoEl) {
                videoEl.style.display = '';
                videoEl.loop = false;
                const url = frame instanceof Blob ? URL.createObjectURL(frame) : frame;
                if (videoEl.src !== url) { videoEl.src = url; videoEl.load(); }
                videoEl.play().catch(()=>{});
            }
        } 
        else {
            showPlaceholder();
        }

        // Actualizar métricas si vienen
        if (data.metric_car_count !== undefined && data.metric_car_count !== null) {
            const el = document.getElementById('car-count-value');
            if (el) el.textContent = data.metric_car_count;
        }

        if (data.metric_person_count !== undefined && data.metric_person_count !== null) {
            const el = document.getElementById('person-count-value');
            if (el) el.textContent = data.metric_person_count;
        }
         if (data.metric_bici_count !== undefined && data.metric_bici_count !== null) {
            const el = document.getElementById('bicycle-count-value');
            if (el) el.textContent = data.metric_bici_count;
        }
        
        if (typeof ConnectionStatus !== 'undefined') ConnectionStatus.onFrame();
    });

    socket.on('disconnect', () => {
        console.warn('Socket desconectado — mostrando placeholder');
        showPlaceholder();
        if (_imageWatchdog) clearTimeout(_imageWatchdog);
    });

    socket.on('connect', () => resetImageWatchdog());

    // Inicializar placeholder al inicio
    showPlaceholder();

    </script>

    <!--Script para el botón de "volver arriba"-->
    <script>
        (function () {
            const btn = document.getElementById('scroll-up');
            if (!btn) return;
            const THRESHOLD = 100; // px para mostrar el botón

            function onScroll() {
                if (window.scrollY > THRESHOLD) btn.classList.add('show');
                else btn.classList.remove('show');
            }

            // click: subir suave (respeta prefers-reduced-motion)
            btn.addEventListener('click', () => {
                if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                    window.scrollTo(0, 0);
                } else {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            });

            window.addEventListener('scroll', onScroll, { passive: true });
            document.addEventListener('DOMContentLoaded', onScroll);
        })();
    </script>

    <!-- Toggler para activar .scrolled al hacer scroll -->
    <script>
        (function () {
            const THRESHOLD = 20; // píxeles para activar el efecto
            function toggleScrolled() {
                document.body.classList.toggle('scrolled', window.scrollY > THRESHOLD);
            }
            window.addEventListener('scroll', toggleScrolled, { passive: true });
            document.addEventListener('DOMContentLoaded', toggleScrolled);
        })();
    </script>

     <!--Script para logo navbar: sube suave si ya has bajado-->
    <script>
        (function () {
            const logo = document.querySelector('.navbar-brand');
            if (!logo) return;
            const THRESHOLD = 80; // si has bajado más de 80px, el logo sube

            logo.addEventListener('click', (e) => {
                if (window.scrollY > THRESHOLD) {
                    e.preventDefault(); // evita ir a index.html
                    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                        window.scrollTo(0, 0);
                    } else {
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                }
                // si scrollY <= THRESHOLD, deja que el href="index.html" funcione
            });
        })();
    </script>
     <!-- Script para mandar los frames al backend  -->

    <!--Script para la tabla de vídeos guardados-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://unpkg.com/bootstrap-table/dist/bootstrap-table.min.js"></script>
 
    <script>
    const url = window.serverSettings.url;
    (function () {
    const API_VIDEOS = url + ':3000/video';
 
    function fmtDateShort(iso) {
        const d = new Date(iso);
        const datePart = d.toLocaleDateString('es-ES', { day:'2-digit', month:'short', year:'numeric' }).replace(/\./g,'');
        const timePart = d.toLocaleTimeString('es-ES', { hour:'2-digit', minute:'2-digit' });
        return `${datePart} · ${timePart}`;
    }
 
    function toTableRows(videos) {
        function formatDuration(seconds) {
            if (!seconds) return '0 s';
            if (seconds < 60) return `${seconds} s`;
            
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes} min ${remainingSeconds} s`;
        }

        return videos.map(v => ({
            id_video: v.id_video,
            fecha: fmtDateShort(v.fecha_hora),
            titulo: `<a href="video_grande.html?id=${encodeURIComponent(v.id_video)}">Grabación ${v.id_video}</a>`,
            metrica_coches: v.metrica_coches ?? 0,
            metrica_personas: v.metrica_personas ?? 0,
            metrica_bici: v.metrica_bici ?? 0, 
            duracion: formatDuration(v.duracion),
            estado: v.procesado ? '<span class="status-procesado">Procesado</span>' : '<span class="status-pendiente">Pendiente</span>'
        }));
    }
 
 
    function initTable(rows) {
        const $table = $('#fresh-table');
        if ($table.data('bootstrap.table')) $table.bootstrapTable('destroy');
 
        $table.bootstrapTable({
        data: rows,
        toolbar: '.toolbar',
        search: true,
        info: false,
        showRefresh: false,
        showToggle: false,
        showColumns: false,
        pagination: true,
        striped: true,
        sortable: true,
        pageSize: 5,
        pageList: [5, 10, 25, 50, 100],
        classes: 'table table-hover table-striped',
        escape: false,
        language: 'es-ES',
        formatSearch: () => 'Buscar',
        formatShowingRows: () => '',
        formatRecordsPerPage: n => n + ' filas visibles',
        formatNoMatches: () => 'No se encontraron resultados'
        });
        
    const $searchInput = $('.fixed-table-toolbar .search input');
    $('.fixed-table-toolbar .search').css('position', 'relative');
    const $icon = $('<i class="fa fa-search position-absolute" style="left:15px; top:50%; transform:translateY(-50%); color:#888;"></i>');
    $('.fixed-table-toolbar .search').append($icon);
    $searchInput.css('padding-left', '2.5rem'); 

    }
 
     function loadFromApi() {
        console.log('Cargando vídeos desde', API_VIDEOS);
        fetch(API_VIDEOS, { cache: 'no-store' })
            .then(res => { if (!res.ok) throw new Error('HTTP ' + res.status); return res.json(); })
            .then(data => {
                // Filtrar sólo los videos procesados (procesado === 1)
                const processed = Array.isArray(data) ? data.filter(v => Number(v.procesado) === 1) : [];
                initTable(toTableRows(processed));
            })
            .catch(err => { console.error('Error cargando /video:', err); initTable([]); });
    }
 
 
    $(document).ready(loadFromApi);
    })();
    </script>

     <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Live chart: evolución últimas 60s -->
    <script>
    (function(){
        const canvas = document.getElementById('liveChart');
        if (!canvas) return;

        if (typeof Chart !== 'undefined' && Chart.defaults && Chart.defaults.font) {
            Chart.defaults.font.family = "'Merriweather', serif";
            Chart.defaults.font.size = 12;    // opcional
            Chart.defaults.font.weight = '400'; // opcional
        }

        const ctx = canvas.getContext('2d');
        const MAX_SAMPLES = 60;     // segundos
        const INTERVAL_MS = 1000;   // muestreo cada 1s

        const data = {
            labels: [], // marcas temporales
            datasets: [
                {
                    label: 'Coches',
                    data: [],
                    borderColor: '#2ecc71',
                    backgroundColor: 'rgba(46,204,113,0.15)',
                    fill: true,
                    tension: 0.25,
                },
                {
                    label: 'Personas',
                    data: [],
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52,152,219,0.12)',
                    fill: true,
                    tension: 0.25,
                },
                {
                    label: 'Bicicletas',
                    data: [],
                    borderColor: '#f39c12',
                    backgroundColor: 'rgba(243,156,18,0.12)',
                    fill: true,
                    tension: 0.25,
                }
            ]
        };

        const config = {
            type: 'line',
            data: data,
            options: {
                responsive: true,
                animation: false,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' }
                },
                scales: {
                    x: {
                        display: true,
                        title: { display: true, text: 'Hora' },
                        ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 12 }
                    },
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Número de detecciones' }
                    }
                }
            }
        };

        const liveChart = new Chart(ctx, config);

        function readMetric(id) {
            const el = document.getElementById(id);
            if (!el) return 0;
            const v = parseInt(el.textContent || el.innerText || '0', 10);
            return Number.isNaN(v) ? 0 : v;
        }

        function pushSample() {
            const now = new Date();
            const ts = now.toLocaleTimeString();
            // leer métricas (estos elementos siempre existen y valen 0 si no hay datos)
            const cars = readMetric('car-count-value');
            const persons = readMetric('person-count-value');
            const bicycles = readMetric('bicycle-count-value');

            data.labels.push(ts);
            data.datasets[0].data.push(cars);
            data.datasets[1].data.push(persons);
            data.datasets[2].data.push(bicycles);

            // mantener ventana de MAX_SAMPLES
            if (data.labels.length > MAX_SAMPLES) {
                data.labels.shift();
                data.datasets.forEach(ds => ds.data.shift());
            }

            // actualizar sin animación perceptible
            liveChart.update('none');
        }

        // empezar muestreo inmediato y luego cada segundo
        pushSample();
        setInterval(pushSample, INTERVAL_MS);
    })();
    </script>

   

    <script>
    document.addEventListener("DOMContentLoaded", function () {

        const carousel = document.getElementById("heroCarousel");
        let marker = null; 
        let gpsInterval = null; 
        let timeoutCheck = null;
        let lastReceived = null;

        const url = window.serverSettings.url;
        const API_GPS = url + ':3000/gps';
        const initialView = [43.524398, -5.629113];
        const initialZoom = 16;

        var greenIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        // Función para pedir coordenadas GPS
        function actualizarGPS() {
            fetch(API_GPS)
                .then(r => r.json())
                .then(data => {
                    console.log("Datos GPS recibidos:", data);
                    if (!data.latitud || !data.longitud) return;

                    lastReceived = Date.now(); // actualizar timestamp

                    if (!marker) {
                        marker = L.marker([data.latitud, data.longitud], {icon: greenIcon}).addTo(window.map);
                    } else {
                        marker.setLatLng([data.latitud, data.longitud]);
                    }

                    window.map.panTo([data.latitud, data.longitud]);
                })
                .catch(err => console.error("Error obteniendo GPS:", err));
        }

        function checkTimeout() {
            if (!lastReceived) return;
            const now = Date.now();
            const timeout = 10000; // 10 segundos sin coordenadas
            if (now - lastReceived > timeout) {
                if (marker) {
                    window.map.removeLayer(marker);
                    marker = null;
                }
                window.map.setView(initialView, initialZoom);
                lastReceived = null;
            }
        }

        carousel.addEventListener("slid.bs.carousel", function (event) {
            const active = event.to; 

            if (active === 1) {  
                if (!window._mapInitialized) {
                    window._mapInitialized = true;

                    window.map = L.map("map").setView(initialView, initialZoom);

                    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                        maxZoom: 19,
                        attribution: "&copy; OpenStreetMap"
                    }).addTo(window.map);
                }

                setTimeout(() => window.map.invalidateSize(), 200);

                if (!gpsInterval) {
                    gpsInterval = setInterval(actualizarGPS, 3000);
                    actualizarGPS(); 
                }

                if (!timeoutCheck) {
                    timeoutCheck = setInterval(checkTimeout, 2000);
                }

            } else {
                if (gpsInterval) {
                    clearInterval(gpsInterval);
                    gpsInterval = null;
                }
                if (timeoutCheck) {
                    clearInterval(timeoutCheck);
                    timeoutCheck = null;
                }
            }
        });

    });
</script>



  
</body>
</html>



